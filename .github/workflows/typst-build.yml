name: Build and Deploy Typst Resume

on:
  push:
    branches: [main]
    paths:
      - '**.typ'
  workflow_dispatch:

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout source
        uses: actions/checkout@v3

      - name: Install Typst
        uses: typst-community/setup-typst@v3

      - name: Install Chinese fonts
        run: |
          sudo apt-get update
          sudo apt-get install -y fonts-noto-cjk fonts-noto-cjk-extra
          fc-cache -fv

      - name: Get filename and commit info
        id: meta
        run: |
          DATE=$(date +%Y-%m-%d)
          COMMIT_HASH=$(git rev-parse --short HEAD)
          COMMIT_MSG=$(git log -1 --pretty=%s)
          FILENAME="resume-${DATE}-${COMMIT_HASH}.pdf"
          echo "filename=$FILENAME" >> $GITHUB_OUTPUT
          echo "message=$COMMIT_MSG" >> $GITHUB_OUTPUT

      - name: Compile PDF
        run: |
          mkdir -p output
          typst compile main.typ output/${{ steps.meta.outputs.filename }}

      - name: Checkout gh-pages branch
        uses: actions/checkout@v3
        with:
          ref: gh-pages
          path: gh-pages

      - name: Copy new PDF and update notes
        run: |
          cd gh-pages
          cp ../output/${{ steps.meta.outputs.filename }} .

          # 更新 notes.json（保留已有备注）
          NOTE_FILE="notes.json"
          NOTE_TEXT="${{ steps.meta.outputs.message }}"
          FILENAME="${{ steps.meta.outputs.filename }}"

          if [ -f $NOTE_FILE ]; then
            jq --arg f "$FILENAME" --arg n "$NOTE_TEXT" '. + {($f): .[$f] // $n}' $NOTE_FILE > tmp.json && mv tmp.json $NOTE_FILE
          else
            echo "{\"$FILENAME\": \"$NOTE_TEXT\"}" > $NOTE_FILE
          fi

          # 生成 index.html
          echo '<!DOCTYPE html><html><head><meta charset="utf-8"><title>简历历史</title><style>body{font-family:sans-serif;max-width:700px;margin:auto;padding:2em}li{margin-bottom:1em}.note{color:#666;font-size:.9em}</style></head><body><h1>历史简历版本</h1><ul>' > index.html

          for f in $(ls resume-*.pdf | sort -r); do
            desc=$(jq -r --arg f "$f" '.[$f] // "无备注"' $NOTE_FILE)
            echo "<li><a href=\"$f\">$f</a><br/><span class=\"note\">$desc</span></li>" >> index.html
          done

          echo '</ul></body></html>' >> index.html

      - name: Deploy to GitHub Pages
        uses: peaceiris/actions-gh-pages@v4
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: gh-pages
          keep_files: true
